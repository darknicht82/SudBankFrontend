<!-- ========================================
   COMPONENTE L03 MAIN - TEMPLATE CORREGIDO
   ======================================== -->

<div class="l03-main-container">
  <!-- HEADER L03 -->
  <div class="header">
    <h1>Dashboard L03 - Estructura de Inversiones</h1>
    <p class="subtitle">Gestión y monitoreo de estructuras L03 según manual SB</p>
  </div>

  <!-- INFORMACIÓN DE ESTRUCTURA L03 -->
  <div class="structure-info">
    <div class="card">
      <div class="card-header">
        <h3>Información de Estructura L03</h3>
      </div>
      <div class="card-content">
        <p><strong>Descripción:</strong> Estructura de inversiones y títulos de deuda</p>
        <p><strong>Periodicidad:</strong> Mensual</p>
        <p><strong>Plazo entrega:</strong> Día 15 del mes siguiente</p>
        <p><strong>Código Banco:</strong> 1038</p>
        <p><strong>Formato archivo:</strong> TXT (RVC)</p>
        <p><strong>Fuente:</strong> Manual SB - Control de Inversiones</p>
        
        <div class="requirements">
          <h4>Requisitos:</h4>
          <ul>
            <li>Datos de títulos de deuda e inversiones</li>
            <li>Valores en USD</li>
            <li>Calificaciones de riesgo</li>
            <li>Información de custodios</li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <!-- ACCIONES PRINCIPALES L03 -->
  <div class="action-buttons">
    <button (click)="loadData()" [disabled]="loading" class="btn btn-primary">
      <i class="fas fa-sync-alt me-2"></i>
      {{ loading ? 'Cargando...' : 'Cargar Datos L03' }}
    </button>
    
    <button (click)="openNewRecordModal()" class="btn btn-info">
      <i class="fas fa-plus me-2"></i>
      Nuevo Registro L03
    </button>
    
    <button (click)="exportToTxt()" [disabled]="datosL03.length === 0" class="btn btn-success">
      <i class="fas fa-download me-2"></i>
      Exportar TXT
    </button>
    
    <button (click)="clearGridFilters()" [disabled]="filteredDataL03.length === datosL03.length" class="btn btn-secondary">
      <i class="fas fa-filter me-2"></i>
      Limpiar Filtros
    </button>
  </div>

  <!-- FILTROS L03 -->
  <div class="filters-section">
    <div class="card">
      <div class="card-header">
        <h3>Filtros de Búsqueda</h3>
      </div>
      <div class="card-content">
        <div class="filters-grid">
          <div class="form-field">
            <label for="tipoIdentificacion">Tipo de Identificación</label>
            <select id="tipoIdentificacion" [(ngModel)]="tipoIdentificacion" class="form-control">
              <option value="">Todos</option>
              <option *ngFor="let tipo of tiposIdentificacionL01" [value]="tipo.codigo">
                {{ tipo.codigo }} - {{ tipo.descripcion }}
              </option>
            </select>
          </div>
          
          <div class="form-field">
            <label for="clasificacion">Clasificación</label>
            <select id="clasificacion" [(ngModel)]="clasificacion" class="form-control">
              <option value="">Todas</option>
              <option *ngFor="let clasif of clasificacionesL01" [value]="clasif.codigo">
                {{ clasif.codigo }} - {{ clasif.descripcion }}
              </option>
            </select>
          </div>
          
          <div class="form-field">
            <label for="tipoEmisor">Tipo de Emisor</label>
            <select id="tipoEmisor" [(ngModel)]="tipoEmisor" class="form-control">
              <option value="">Todos</option>
              <option *ngFor="let tipo of tiposEmisorL01" [value]="tipo.codigo">
                {{ tipo.codigo }} - {{ tipo.descripcion }}
              </option>
            </select>
          </div>
        </div>
        
        <div class="actions">
          <button (click)="applyGridFilters()" class="btn btn-primary">
            <i class="fas fa-search me-2"></i>
            Aplicar Filtros
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- RESUMEN L03 -->
  <div class="summary-section">
    <div class="card">
      <div class="card-header">
        <h3>Resumen de Datos L03</h3>
      </div>
      <div class="card-content">
        <div class="summary-grid">
          <div class="summary-item">
            <label>Total Registros:</label>
            <span>{{ getTotalRegistros() }}</span>
          </div>
          
          <div class="summary-item">
            <label>Registros Filtrados:</label>
            <span>{{ filteredDataL03.length }}</span>
          </div>
          
          <div class="summary-item">
            <label>Fecha Generación:</label>
            <span>{{ getFechaGeneracion() }}</span>
          </div>
          
          <div class="summary-item">
            <label>Usuario:</label>
            <span>{{ usuarioActual }}</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- TABLA DE DATOS L03 -->
  <div class="data-section">
    <div class="card">
      <div class="card-header">
        <h3>Datos L03 - Estructura de Inversiones</h3>
      </div>
      <div class="card-content">
        <!-- MENSAJE CUANDO NO HAY DATOS -->
        <div *ngIf="datosL03.length === 0 && !loading" class="no-data-message">
          <div class="alert alert-info">
            <h4>No hay datos disponibles</h4>
            <p>No se encontraron registros L03 en el sistema.</p>
            <div class="debug-info">
              <h5>Información de Debug:</h5>
              <ul>
                <li><strong>Estado:</strong> {{ loading ? 'Cargando...' : 'Completado' }}</li>
                <li><strong>Error:</strong> {{ error || 'Ninguno' }}</li>
                <li><strong>Total registros:</strong> {{ datosL03.length }}</li>
              </ul>
              <button (click)="loadData()" class="btn btn-primary">
                <i class="fas fa-sync-alt me-2"></i>
                Intentar Cargar Nuevamente
              </button>
            </div>
          </div>
        </div>

        <!-- MENSAJE DE REGISTROS FILTRADOS -->
        <div *ngIf="filteredDataL03.length < datosL03.length && datosL03.length > 0" class="filtered-records-message">
          <div class="alert alert-warning">
            <h4>Registros Filtrados</h4>
            <p>Se están mostrando <strong>{{ filteredDataL03.length }}</strong> de <strong>{{ datosL03.length }}</strong> registros totales.</p>
            <ul>
              <li><strong>Filtros aplicados:</strong></li>
              <li *ngIf="tipoIdentificacion">Tipo de Identificación: {{ getTipoIdentificacionDesc(tipoIdentificacion) }}</li>
              <li *ngIf="clasificacion">Clasificación: {{ getClasificacionDesc(clasificacion) }}</li>
              <li *ngIf="tipoEmisor">Tipo Emisor: {{ getTipoEmisorDesc(tipoEmisor) }}</li>
            </ul>
            <div class="text-muted">
              <small>Para ver todos los registros, limpie los filtros aplicados.</small>
            </div>
          </div>
        </div>

        <!-- TABLA DE DATOS -->
        <div *ngIf="filteredDataL03.length > 0" class="table-container">
          <table class="data-table">
            <thead>
              <tr>
                <th *ngFor="let column of displayedColumns" 
                    (mouseenter)="showFieldTooltip(column, $event)"
                    (mouseleave)="hideFieldTooltip()">
                  {{ column | titlecase }}
                </th>
                <th class="action-header">
                  <span class="column-title">Acciones</span>
                </th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let item of filteredDataL03" class="data-row">
                <td>{{ item.codigoTipoIdentificacionEmisor }}</td>
                <td>{{ item.codigoIdentificacionEmisor }}</td>
                <td>{{ item.numeroTitulo }}</td>
                <td>{{ item.fechaEmision | date:'dd/MM/yyyy' }}</td>
                <td>{{ item.valorLibrosUsd | currency:'USD':'symbol':'1.2-2' }}</td>
                <td>{{ item.valorMercadoUsd | currency:'USD':'symbol':'1.2-2' }}</td>
                <td class="action-cell">
                  <div class="action-buttons">
                    <button (click)="openEditRecordModal(item)" class="btn btn-sm btn-primary">
                      <i class="fas fa-edit"></i>
                    </button>
                    <button (click)="refreshData()" class="btn btn-sm btn-info">
                      <i class="fas fa-sync-alt"></i>
                    </button>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- TOOLTIP L03 -->
  <div *ngIf="showTooltip && currentTooltip" 
       class="tooltip-popup" 
       [style.left.px]="tooltipPosition.x + 10"
       [style.top.px]="tooltipPosition.y - 10">
    <div class="tooltip-content">
      <h4>{{ currentTooltip?.title || 'Información del Campo' }}</h4>
      <p>{{ currentTooltip?.description || 'Descripción no disponible' }}</p>
    </div>
  </div>

  <!-- CONTROLES DE PRUEBA Y DEBUG -->
  <div class="debug-controls" *ngIf="!loading && showLogMonitor">
    <div class="card">
      <div class="card-header">
        <h5>
          <i class="fas fa-tools me-2"></i>
          Controles de Prueba
        </h5>
      </div>
      <div class="card-content">
        <div class="row">
          <div class="col-md-3">
            <button class="btn btn-outline-danger btn-sm w-100" (click)="testError()">
              <i class="fas fa-bug me-2"></i>
              Simular Error
            </button>
          </div>
          <div class="col-md-3">
            <button class="btn btn-outline-warning btn-sm w-100" (click)="testWarning()">
              <i class="fas fa-exclamation-triangle me-2"></i>
              Simular Advertencia
            </button>
          </div>
          <div class="col-md-3">
            <button class="btn btn-outline-info btn-sm w-100" (click)="refreshData()">
              <i class="fas fa-sync-alt me-2"></i>
              Refrescar Datos
            </button>
          </div>
          <div class="col-md-3">
            <button class="btn btn-outline-secondary btn-sm w-100" (click)="toggleLogMonitor()">
              <i class="fas fa-eye me-2"></i>
              {{ showLogMonitor ? 'Ocultar' : 'Mostrar' }} Monitor
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- MONITOR DE LOGS -->
  <div class="log-monitor-section" *ngIf="showLogMonitor">
    <app-log-monitor></app-log-monitor>
  </div>

  <!-- LOADING -->
  <div *ngIf="loading" class="loading-overlay">
    <div class="loading-spinner">
      <div class="spinner"></div>
      <p>Generando reporte L03...</p>
    </div>
  </div>

  <!-- MODAL DEL FORMULARIO L03 (PLACEHOLDER) -->
  <div *ngIf="showModalForm" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h3>{{ editData ? 'Editar Registro L03' : 'Nuevo Registro L03' }}</h3>
        <button (click)="onModalClosed()" class="close-button">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <p>Componente modal L03 en desarrollo...</p>
        <p>Datos: {{ editData ? 'Modo edición' : 'Modo creación' }}</p>
      </div>
      <div class="modal-footer">
        <button (click)="onModalClosed()" class="btn btn-secondary">
          Cancelar
        </button>
        <button (click)="onModalDataSaved(editData)" class="btn btn-primary">
          {{ editData ? 'Actualizar' : 'Crear' }}
        </button>
      </div>
    </div>
  </div>
</div>
