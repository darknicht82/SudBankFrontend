<!-- COMPONENTE L01 MAIN - DASHBOARD PRINCIPAL -->
<!-- Manual de Control de Inversiones - Marzo 2017 -->
<!-- Superintendencia de Bancos del Ecuador -->

<div class="l01-main-container">
  <!-- CABECERA -->
  <div class="header">
    <h1>L03 - Saldo y Liquidaciones de inversiones</h1>
    <p class="subtitle">Registro de saldo y liquidaciones de inversiones</p>
  </div>

  <!-- INFORMACI√ìN DE ESTRUCTURA -->
  <div class="structure-info">
    <div class="card">
      <div class="card-header">
        <h3>üìã Informaci√≥n de la Estructura L03</h3>
      </div>
      <div class="card-content">
        <p><strong>Descripci√≥n:</strong> Emisores, Custodios de Inversiones, Depositarios de Fondos Disponibles y Contrapartes en Operaciones de Reporto</p>
        <p><strong>Periodicidad:</strong> Eventual (solo cuando hay nuevos datos)</p>
        <p><strong>Plazo entrega:</strong> Seg√∫n requerimientos de la SB</p>
        <p><strong>C√≥digo Banco:</strong> 1038</p>
        <p><strong>Formato archivo:</strong> L01Exxxxddmmaaaa.txt</p>
        <p><strong>Fuente:</strong> Manual de Control de Inversiones - SB Marzo 2017</p>
        
        <div class="requirements">
          <strong>Requisitos:</strong>
          <ul>
            <li>Estructura eventual (no mensual)</li>
            <li>4 campos oficiales obligatorios</li>
            <li>Formato TXT con separador tabulador</li>
            <li>Validaciones seg√∫n manual SB</li>
          </ul>
        </div>

        <div class="fields-info">
          <strong>Campos Oficiales:</strong>
            <div style="height: 400px;width: 100%;overflow: auto;border: 1px solid #ccc;background: #fff;">
              <app-l03-fields-table></app-l03-fields-table>
            </div> 
        </div>
      </div>
    </div>
  </div>

  <!-- ACCIONES PRINCIPALES DEL DASHBOARD -->
  <div class="actions-section">
    <div class="card">
      <div class="card-header">
        <h3>üöÄ Acciones del Reporte L01</h3>
        <p class="action-description">Acciones principales para la gesti√≥n de la estructura L01 seg√∫n manual SB.</p>
      </div>
      <div class="card-content">
        <div class="actions">
          <button (click)="validateAndGenerateReport()" [disabled]="loading" class="btn btn-primary">
            <i class="pi pi-check-circle"></i>
            {{ loading ? 'Validando...' : 'Validar y Generar Reporte L01 Completo' }}
          </button>
          <button (click)="exportToTxt()" class="btn btn-success">
            <i class="pi pi-download"></i>
            Exportar TXT
          </button>
          <button (click)="openCreateModal()" class="btn btn-info">
            <i class="pi pi-plus"></i>
            Crear Nuevo Registro
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- ERRORES -->
  <div *ngIf="error" class="error-message">
    <div class="alert alert-danger">
      <strong>Error:</strong> {{ error }}
    </div>
  </div>

  <!-- RESUMEN -->
  <div *ngIf="datosL01.length > 0" class="summary-section">
    <div class="card">
      <div class="card-header">
        <h3>üìä Resumen del Reporte</h3>
      </div>
      <div class="card-content">
        <div class="summary-grid">
          <div class="summary-item">
            <label>Total Registros:</label>
            <span>{{ getTotalRegistros() }}</span>
          </div>
          <div class="summary-item">
            <label>Fecha Generaci√≥n:</label>
            <span>{{ getFechaGeneracion() }}</span>
          </div>
          <div class="summary-item">
            <label>Emisores:</label>
            <span>{{ getCountByClasificacion(1) }}</span>
          </div>
          <div class="summary-item">
            <label>Custodios:</label>
            <span>{{ getCountByClasificacion(2) }}</span>
          </div>
          <div class="summary-item">
            <label>Depositarios:</label>
            <span>{{ getCountByClasificacion(3) }}</span>
          </div>
          <div class="summary-item">
            <label>Contrapartes:</label>
            <span>{{ getCountByClasificacion(4) }}</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Componente de Confirmaci√≥n ELIMINADO -->

  <!-- Componente de Resumen del Reporte ELIMINADO -->

  <!-- TABLA DE DATOS -->
  <div class="data-section">
    <div class="card">
      <div class="card-header">
        <h3>üìã Datos del Reporte L01</h3>
      </div>
      <div class="card-content">
        
        <!-- MENSAJE INFORMATIVO SOBRE REGISTROS FILTRADOS -->
        <div *ngIf="registrosFiltrados > 0" class="filtered-records-message">
          <div class="alert alert-warning">
            <h4>‚ö†Ô∏è Registros Filtrados por Validaci√≥n L01</h4>
            <p><strong>Se encontraron {{ registrosFiltrados }} registros que no cumplen con las especificaciones L01:</strong></p>
            <ul>
              <li><strong>C√≥digos de tipo de identificaci√≥n no permitidos:</strong> Solo se permiten c√≥digos <strong>R</strong> y <strong>X</strong></li>
              <li><strong>Registros con c√≥digos C, E, etc. fueron filtrados autom√°ticamente</strong></li>
              <li><strong>Estos registros no aparecen en la tabla pero existen en la base de datos</strong></li>
            </ul>
            <p class="text-muted">
              <small>
                <strong>Nota:</strong> Los registros filtrados contienen c√≥digos de tipo de identificaci√≥n 
                que no est√°n permitidos seg√∫n el manual L01 de la Superintendencia de Bancos del Ecuador.
              </small>
            </p>
          </div>
        </div>
        
        <!-- MENSAJE CUANDO NO HAY DATOS -->
        <div *ngIf="datosL01.length === 0" class="no-data-message">
          <div class="alert alert-info">
            <h4>üìä Estado de los Datos L01</h4>
            <p><strong>Total de registros:</strong> {{ datosL01.length }}</p>
            <p><strong>Estado de carga:</strong> {{ loading ? 'üîÑ Cargando...' : '‚úÖ Carga completada' }}</p>
            <p><strong>Error:</strong> {{ error || 'Ninguno' }}</p>
            
            <div class="debug-info" *ngIf="!loading">
              <h5>üîç Informaci√≥n de Debug:</h5>
              <ul>
                <li><strong>Cat√°logos cargados:</strong> 
                  T4: {{ tiposIdentificacionL01.length }}, 
                  T173: {{ clasificacionesL01.length }}, 
                  T73: {{ tiposEmisorL01.length }}, 
                  T164: {{ codigosExtranjerosL01.length }}
                </li>
                <li><strong>Datos del backend:</strong> {{ datosL01.length }} registros</li>
                <li><strong>Datos filtrados:</strong> {{ filteredDataL01.length }} registros</li>
              </ul>
              
              <button (click)="refreshData()" class="btn btn-primary">
                üîÑ Refrescar Datos
              </button>
            </div>
          </div>
        </div>
        
        <!-- FILTROS PARA VISTA DEL GRID -->
        <div class="grid-filters">
          <h4>üîç Filtros para Vista del Grid</h4>
          <p class="filter-description">Utilice estos filtros para analizar y contar registros por categor√≠a en la vista actual.</p>
          <div class="filters-grid">
            <div class="form-field">
              <label>Tipo Identificaci√≥n:</label>
              <select [(ngModel)]="tipoIdentificacion" class="form-control" (change)="applyGridFilters()">
                <option value="">Todos</option>
                <option *ngFor="let tipo of tiposIdentificacionL01" [value]="tipo.codigo">
                  {{tipo.codigo}} - {{tipo.descripcion}}
                </option>
              </select>
            </div>
            <div class="form-field">
              <label>Clasificaci√≥n:</label>
              <select [(ngModel)]="clasificacion" class="form-control" (change)="applyGridFilters()">
                <option value="">Todas</option>
                <option *ngFor="let clasificacion of clasificacionesL01" [value]="clasificacion.codigo">
                  {{clasificacion.codigo}} - {{clasificacion.descripcion | titlecase}}
                </option>
              </select>
            </div>
            <div class="form-field">
              <label>Tipo Emisor:</label>
              <select [(ngModel)]="tipoEmisor" class="form-control" (change)="applyGridFilters()">
                <option value="">Todos</option>
                <option *ngFor="let tipo of tiposEmisorL01" [value]="tipo.codigo">
                  {{tipo.codigo}} - {{tipo.descripcion | titlecase}}
                </option>
              </select>
            </div>
          </div>
          
          <!-- RESUMEN DE FILTROS APLICADOS -->
          <div class="filters-summary" *ngIf="tipoIdentificacion || clasificacion || tipoEmisor">
            <h5>üìä Resumen de Filtros Aplicados:</h5>
            <div class="summary-items">
              <span *ngIf="tipoIdentificacion" class="summary-item">
                Tipo: {{ getTipoIdentificacionDesc(tipoIdentificacion) }}
              </span>
              <span *ngIf="clasificacion" class="summary-item">
                Clasificaci√≥n: {{ getClasificacionDesc(+clasificacion) }}
              </span>
              <span *ngIf="tipoEmisor" class="summary-item">
                Tipo Emisor: {{ getTipoEmisorDesc(+tipoEmisor) }}
              </span>
            </div>
            <button (click)="clearGridFilters()" class="btn btn-sm btn-outline-secondary">
              <i class="pi pi-times"></i>
              Limpiar Filtros
            </button>
          </div>
        </div>

        <div class="table-container">
          <table class="data-table">
            <thead>
              <tr>
                <th *ngFor="let column of displayedColumns" 
                    (mouseenter)="showFieldTooltip(column, $event)"
                    (mouseleave)="hideTooltip()">
                  {{ getColumnTitle(column) }}
                </th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let item of filteredDataL01; let i = index" class="data-row">
                <!-- Tipo Identificaci√≥n -->
                <td class="data-cell">
                  <span class="cell-value">{{ item.tipoIdentificacion === 'R' ? 'R - RUC Nacional' : 'X - C√≥digo Extranjero' }}</span>
                </td>

                <!-- Identificaci√≥n -->
                <td class="data-cell">
                  <span class="cell-value">{{ item.identificacion }}</span>
                </td>

                <!-- Clasificaci√≥n -->
                <td class="data-cell">
                  <div class="cell-content">
                    <span class="cell-value">{{ getClasificacionDesc(item.clasificacion) }}</span>
                    <button class="btn btn-sm btn-outline-primary edit-btn" 
                            (click)="openEditModal(item)" 
                            title="Editar registro">
                      ‚úèÔ∏è
                    </button>
                  </div>
                </td>

                <!-- Tipo Emisor -->
                <td class="data-cell">
                  <div class="cell-content">
                    <span class="cell-value">{{ getTipoEmisorDesc(item.tipoEmisor) }}</span>
                    <button class="btn btn-sm btn-outline-primary edit-btn" 
                            (click)="openEditModal(item)" 
                            title="Editar registro">
                      ‚úèÔ∏è
                    </button>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- TOOLTIP L01 -->
  <div *ngIf="showTooltip && currentTooltip" 
       class="tooltip-popup" 
       [style.left.px]="tooltipPosition.x + 10"
       [style.top.px]="tooltipPosition.y - 10">
    <div class="tooltip-content">
      <h4>{{ currentTooltip.title }}</h4>
      <p>{{ currentTooltip.description }}</p>
      
      <div class="tooltip-details">
        <div class="tooltip-row">
          <strong>Formato:</strong> {{ currentTooltip.format }}
        </div>
        <div class="tooltip-row">
          <strong>Validaci√≥n:</strong> {{ currentTooltip.validation }}
        </div>
        <div class="tooltip-row">
          <strong>Ejemplo:</strong> {{ currentTooltip.example }}
        </div>
        <div class="tooltip-row">
          <strong>Fuente:</strong> {{ currentTooltip.source }}
        </div>
      </div>
    </div>
  </div>

  <!-- COMPONENTE DE EXPORTACI√ìN L01 ELIMINADO -->

  <!-- CONTROLES DE PRUEBA Y DEBUG -->
  <div class="debug-controls" *ngIf="!loading && showLogMonitor">
    <div class="card">
      <div class="card-header">
        <h5>
          <i class="fas fa-tools me-2"></i>
          Controles de Prueba
        </h5>
      </div>
      <div class="card-content">
        <div class="row">
          <div class="col-md-3">
            <button class="btn btn-outline-danger btn-sm w-100" (click)="testError()">
              <i class="fas fa-bug me-2"></i>
              Simular Error
            </button>
          </div>
          <div class="col-md-3">
            <button class="btn btn-outline-warning btn-sm w-100" (click)="testWarning()">
              <i class="fas fa-exclamation-triangle me-2"></i>
              Simular Advertencia
            </button>
          </div>
          <div class="col-md-3">
            <button class="btn btn-outline-info btn-sm w-100" (click)="refreshData()">
              <i class="fas fa-sync-alt me-2"></i>
              Refrescar Datos
            </button>
          </div>
          <div class="col-md-3">
            <button class="btn btn-outline-secondary btn-sm w-100" (click)="toggleLogMonitor()">
              <i class="fas fa-eye me-2"></i>
              {{ showLogMonitor ? 'Ocultar' : 'Mostrar' }} Monitor
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- MONITOR DE LOGS -->
  <div class="log-monitor-section" *ngIf="showLogMonitor">
    <app-log-monitor></app-log-monitor>
  </div>

  <!-- LOADING -->
  <div *ngIf="loading" class="loading-overlay">
    <div class="loading-spinner">
      <div class="spinner"></div>
      <p>Generando reporte L01...</p>
    </div>
  </div>

  <!-- MODAL DEL FORMULARIO L01 -->
  <app-l01-modal-form
    [isVisible]="showModalForm"
    [editData]="editData"
    (modalClosed)="onModalClosed()"
    (dataSaved)="onModalDataSaved($event)">
  </app-l01-modal-form>

  <!-- MODAL DE RESULTADOS DE VALIDACI√ìN L01 ELIMINADO -->
</div>
