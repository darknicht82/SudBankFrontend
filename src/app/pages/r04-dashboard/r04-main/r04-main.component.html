<div class="r04-main-container">
    <!-- CABECERA -->
    <div class="header">
        <h1>R04 - Saldos de Operaciones</h1>
        <p class="subtitle">Se deber谩 reportar 煤nicamente los nuevos t铆tulos que se hayan instrumentado cada mes. Cada
            t铆tulo debe reportarse una 煤nica vez en esta estructura, hasta que se lo venda o liquide.</p>
    </div>

    <!-- INFORMACIN DE ESTRUCTURA -->
    <div class="structure-info">
        <div class="card">
            <div class="card-header">
                <h3> Informaci贸n de la Estructura R04</h3>
            </div>
            <div class="card-content">
                <p><strong>Descripci贸n:</strong> Contiene los saldos de todas las operaciones crediticias activas y contingentes que se encuentren registradas en el balance de la entidad financiera a la fecha de corte. Incluye el detalle de operaciones por vencer, vencidas, y en diferentes rangos de morosidad.</p>
                <p><strong>Periodicidad:</strong> Mensual (M)</p>
                <p><strong>Plazo entrega:</strong> Seg煤n requerimientos de la Superintendencia de Bancos</p>
                <p><strong>C贸digo Banco:</strong> 1038</p>
                <p><strong>Formato archivo:</strong> r04Exxxxddmmaaaa.txt</p>
                <p><strong>Fuente:</strong> Manual T茅cnico de Estructuras de Datos de Operaciones Activas y Contingentes - Versi贸n 13.0 - 27/09/2023</p>
                <div class="requirements">
                    <strong>Requisitos:</strong>
                    <ul>
                        <li>Estructura mensual obligatoria</li>
                        <li>50 campos oficiales (12 obligatorios, 38 opcionales)</li>
                        <li>Formato TXT con separador tabulador</li>
                        <li>Validaciones seg煤n manual SB</li>
                        <li>Reporte de saldos por vencer y vencidos</li>
                        <li>Clasificaci贸n por rangos de morosidad</li>
                    </ul>
                </div>

                <strong>Campos Oficiales:</strong>
                <div style="height: 400px;width: 100%;overflow: auto;border: 1px solid #ccc;background: #fff;">
                    <app-r04-table></app-r04-table>
                </div>
            </div>
        </div>
    </div>

    <!-- RESUMEN -->
    <div class="summary-section">
        <div class="card">
            <div class="card-header">
                <h3> Resumen del Reporte</h3>
            </div>
            <div class="card-content">
                <div class="summary-grid">
                    <div class="summary-item">
                        <label>Total Registros:</label>
                        <span>{{ getTotalRegistros() }}</span>
                    </div>
                    <div class="summary-item">
                        <label>Fecha Generaci贸n:</label>
                        <span>{{ getFechaGeneracion() }}</span>
                    </div>
                    <div class="summary-item">
                        <label>Emisores nicos:</label>
                        <span>{{ getTotalEmisores() }}</span>
                    </div>
                    <div class="summary-item">
                        <label>Operaciones Activas:</label>
                        <span>{{ getTotalRegistros() }}</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="data-section">
        <div class="table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Tipo Identificaci贸n</th>
                        <th>Identificaci贸n Sujeto</th>
                        <th>N煤mero Operaci贸n</th>
                        <th>D铆as Morosidad</th>
                        <th>Calificaci贸n Propia</th>
                        <th>Tasa Inter茅s</th>
                        <th>Valor Vencido 1-30</th>
                        <th>Valor Vencido 31-90</th>
                        <th>Provisi贸n Constituida</th>
                        <th>Tipo Operaci贸n</th>
                        <th>Fecha Exigibilidad Cuota</th>
                        <th>Tipo Sistema Amortizaci贸n</th>
                    </tr>
                </thead>
                <tbody>
                    <tr *ngFor="let item of arrayResume">
                        <td class="data-cell">
                            <span class="cell-value">{{ item.tipoIdentificacion?.descripcion }}</span>   
                        </td>
                        <td class="data-cell">
                            <span class="cell-value">{{ item.identificacionSujeto }}</span>
                        </td>
                        <td class="data-cell">
                            <span class="cell-value">{{ item.numeroOperacion }}</span>
                        </td>
                        <td class="data-cell">
                            <span class="cell-value">{{ item.diasMorosidad }}</span>
                        </td>
                        <td class="data-cell">
                            <span class="cell-value">{{ item.calificacionPropia?.descripcion }}</span>
                        </td>
                        <td class="data-cell">
                            <span class="cell-value">{{ item.tasaInteres | number:'1.2-2' }}%</span>
                        </td>
                        <td class="data-cell">
                            <span class="cell-value">{{ item.valorVencido1a30 | currency:'USD':'symbol':'1.2-2' }}</span>
                        </td>
                        <td class="data-cell">
                            <span class="cell-value">{{ item.valorVencido31a90 | currency:'USD':'symbol':'1.2-2' }}</span>
                        </td>
                        <td class="data-cell">
                            <span class="cell-value">{{ item.provisionConstituida | currency:'USD':'symbol':'1.2-2' }}</span>
                        </td>
                        <td class="data-cell">
                            <span class="cell-value">{{ item.tipoOperacion?.descripcion }}</span>
                        </td>
                        <td class="data-cell">
                            <span class="cell-value">{{ item.fechaExigibilidadCuota | date:'dd/MM/yyyy' }}</span>
                        </td>
                        <td class="data-cell">
                            <span class="cell-value">{{ item.tipoSistemaAmortizacion?.descripcion }}</span>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <div class="d-flex gap-2">
        <button (click)="validateAndGenerateReport()" [disabled]="loading" class="btn btn-primary">
            <i class="pi pi-check-circle"></i>
            {{ loading ? 'Validando...' : 'Validar y Generar Reporte R04' }}
        </button>

        <button (click)="exportToTxt()" class="btn btn-success">
            <i class="pi pi-download"></i>
            Exportar TXT
        </button>

        <button (click)="openModal()" class="btn btn-info">
            <i class="pi pi-plus"></i>
            Crear Nuevo Registro
        </button>
    </div>

    <app-r04-modal-form [isVisible]="showModalForm" (modalClosed)="onModalClosed()"></app-r04-modal-form>

    <div *ngIf="loading" class="loading-overlay">
        <div class="loading-spinner">
            <div class="spinner"></div>
            <p>Generando reporte R04...</p>
        </div>
    </div>
</div>