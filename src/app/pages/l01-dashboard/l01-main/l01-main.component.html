<!-- Superintendencia de Bancos del Ecuador -->

<div class="L01-main-container">
  <!-- CABECERA -->
  <div class="header">
    <h1>L01 - Emisores, Custodios y Contrapartes</h1>
    <p class="subtitle">Registro de emisores, custodios de inversiones, depositarios de fondos disponibles y
      contrapartes en operaciones de reporto</p>
  </div>

  <!-- INFORMACI√ìN DE ESTRUCTURA -->
  <div class="structure-info">
    <div class="card">
      <div class="card-header">
        <h3>üìã Informaci√≥n de la Estructura L01</h3>
      </div>
      <div class="card-content">
        <p><strong>Descripci√≥n:</strong> Emisores, Custodios de Inversiones, Depositarios de Fondos Disponibles y
          Contrapartes en Operaciones de Reporto</p>
        <p><strong>Periodicidad:</strong> Eventual (solo cuando hay nuevos datos)</p>
        <p><strong>Plazo entrega:</strong> Seg√∫n requerimientos de la SB</p>
        <p><strong>C√≥digo Banco:</strong> 1038</p>
        <p><strong>Formato archivo:</strong> L01Exxxxddmmaaaa.txt</p>
        <p><strong>Fuente:</strong> Manual de Control de Inversiones - SB Marzo 2017</p>

        <div class="requirements">
          <strong>Requisitos:</strong>
          <ul>
            <li>Estructura eventual (no mensual)</li>
            <li>4 campos oficiales obligatorios</li>
            <li>Formato TXT con separador tabulador</li>
            <li>Validaciones seg√∫n manual SB</li>
          </ul>
        </div>

        <div class="fields-info">
          <strong>Campos Oficiales L01:</strong>
          <div class="fields-grid">
            <div class="field-item">
              <span class="field-position">1.</span>
              <span class="field-name">Tipo de Identificaci√≥n</span>
              <span class="field-table">(Tabla 4)</span>
              <div class="field-description">R (RUC Nacional) o X (Extranjero)</div>
            </div>
            <div class="field-item">
              <span class="field-position">2.</span>
              <span class="field-name">Identificaci√≥n</span>
              <span class="field-table">(Tabla 164)</span>
              <div class="field-description">RUC 13 d√≠gitos o c√≥digo extranjero</div>
            </div>
            <div class="field-item">
              <span class="field-position">3.</span>
              <span class="field-name">Clasificaci√≥n</span>
              <span class="field-table">(Tabla 173)</span>
              <div class="field-description">1=Emisor, 2=Custodio, 3=Depositario, 4=Contraparte</div>
            </div>
            <div class="field-item">
              <span class="field-position">4.</span>
              <span class="field-name">Tipo de Emisor</span>
              <span class="field-table">(Tabla 73)</span>
              <div class="field-description">Sector econ√≥mico seg√∫n tabla 73</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ERRORES -->
  <div *ngIf="error" class="error-message">
    <div class="alert alert-danger">
      <strong>Error:</strong> {{ error }}
    </div>
  </div>

  <!-- RESUMEN -->
  <div *ngIf="arrayResume.length > 0" class="summary-section">
    <div class="card">
      <div class="card-header">
        <h3>üìä Resumen del Reporte</h3>
      </div>
      <div class="card-content">
        <div class="summary-grid">
          <div class="summary-item">
            <label>Total Registros:</label>
            <span>{{ getTotalRegistros() }}</span>
          </div>
          <div class="summary-item">
            <label>Fecha Generaci√≥n:</label>
            <span>{{ getFechaGeneracion() }}</span>
          </div>
          <div class="summary-item">
            <label>Emisores:</label>
            <span>{{ getCountByClasificacion(1) }}</span>
          </div>
          <div class="summary-item">
            <label>Custodios:</label>
            <span>{{ getCountByClasificacion(2) }}</span>
          </div>
          <div class="summary-item">
            <label>Depositarios:</label>
            <span>{{ getCountByClasificacion(3) }}</span>
          </div>
          <div class="summary-item">
            <label>Contrapartes:</label>
            <span>{{ getCountByClasificacion(4) }}</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- TABLA DE DATOS -->
  <div class="data-section">
    <div class="card">
      <div class="card-header">
        <h3>üìã Datos del Reporte L01</h3>
      </div>
      <div class="card-content">

        <!-- MENSAJE INFORMATIVO SOBRE REGISTROS FILTRADOS -->
        <div *ngIf="registrosFiltrados > 0" class="filtered-records-message">
          <div class="alert alert-warning">
            <h4>‚ö†Ô∏è Registros Filtrados por Validaci√≥n L01</h4>
            <p><strong>Se encontraron {{ registrosFiltrados }} registros que no cumplen con las especificaciones
                L01:</strong></p>
            <ul>
              <li><strong>C√≥digos de tipo de identificaci√≥n no permitidos:</strong> Solo se permiten c√≥digos
                <strong>R</strong> y <strong>X</strong></li>
              <li><strong>Registros con c√≥digos C, E, etc. fueron filtrados autom√°ticamente</strong></li>
              <li><strong>Estos registros no aparecen en la tabla pero existen en la base de datos</strong></li>
            </ul>
            <p class="text-muted">
              <small>
                <strong>Nota:</strong> Los registros filtrados contienen c√≥digos de tipo de identificaci√≥n
                que no est√°n permitidos seg√∫n el manual L01 de la Superintendencia de Bancos del Ecuador.
              </small>
            </p>
          </div>
        </div>

        <!-- TABLA DIRECTA SIN FILTROS -->
        <div class="table-container">
          <table class="data-table">
            <thead>
              <tr>
                <th *ngFor="let column of displayedColumns" (mouseenter)="showFieldTooltip(column, $event)"
                  (mouseleave)="hideTooltip()">
                  {{ getColumnTitle(column) }}
                </th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let item of arrayResume; let i = index" class="data-row">
                <!-- Tipo Identificaci√≥n -->
                <td class="data-cell">
                  <span class="cell-value">{{ getTipoIdentificacionDesc(item.codigoTipoIdentificacion) }}</span>
                </td>

                <!-- Identificaci√≥n -->
                <td class="data-cell">
                  <span class="cell-value">{{ getIdentificacionDesc(item.codigoEmisor) }}</span>
                </td>

                <!-- Clasificaci√≥n - SOLO LECTURA -->
                <td class="data-cell">
                  <span class="cell-value">{{ getClasificacionDesc(item.codigoClasificacionEmisor) }}</span>
                </td>

                <!-- Tipo Emisor - SOLO LECTURA -->
                <td class="data-cell">
                  <span class="cell-value">{{ getTipoEmisorDesc(item.codigoTipoEmisor) }}</span>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- ‚úÖ BOTONES DE ACCI√ìN REPOSICIONADOS DEBAJO DE LA TABLA -->
  <div class="actions-section">
    <div class="card">
      <div class="card-content">
        <div class="actions">
          <button (click)="validateAndGenerateReport()" [disabled]="loading" class="btn btn-primary">
            <i class="pi pi-check-circle"></i>
            {{ loading ? 'Validando...' : 'Validar y Generar Reporte L01 Completo' }}
          </button>
          <button (click)="exportToTxt()" class="btn btn-success">
            <i class="pi pi-download"></i>
            Exportar TXT
          </button>
          <button (click)="openModal()" class="btn btn-info">
            <i class="pi pi-plus"></i>
            Crear Nuevo Registro
          </button>
          <button (click)="showAddEmitterModal()" class="btn btn-warning">
            <i class="pi pi-plus-circle"></i>
            Agregar Emisor/Custodio
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- TOOLTIP L01 -->
  <div *ngIf="showTooltip && currentTooltip" class="tooltip-popup" [style.left.px]="tooltipPosition.x + 10"
    [style.top.px]="tooltipPosition.y - 10">
    <div class="tooltip-content">
      <h4>{{ currentTooltip.title }}</h4>
      <p>{{ currentTooltip.description }}</p>

      <div class="tooltip-details">
        <div class="tooltip-row">
          <strong>Formato:</strong> {{ currentTooltip.format }}
        </div>
        <div class="tooltip-row">
          <strong>Validaci√≥n:</strong> {{ currentTooltip.validation }}
        </div>
        <div class="tooltip-row">
          <strong>Ejemplo:</strong> {{ currentTooltip.example }}
        </div>
        <div class="tooltip-row">
          <strong>Fuente:</strong> {{ currentTooltip.source }}
        </div>
      </div>
    </div>
  </div>

  <!-- LOADING -->
  <div *ngIf="loading" class="loading-overlay">
    <div class="loading-spinner">
      <div class="spinner"></div>
      <p>Generando reporte L01...</p>
    </div>
  </div>

  <!-- MODAL DEL FORMULARIO L01 -->
  <app-l01-nuevo-registro-nes [isVisible]="showModalForm" (modalClosed)="onModalClosed()">
  </app-l01-nuevo-registro-nes>

  <!-- MODAL PARA AGREGAR EMISOR/CUSTODIO -->
  <app-l01-nuevo-emisor [(visible)]="showEmitterModal" (emitterAdded)="onEmitterAdded($event)">
  </app-l01-nuevo-emisor>
</div>