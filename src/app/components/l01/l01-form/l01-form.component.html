<div class="l01-form-container">
  <div class="form-header">
    <h2><i class="pi pi-users"></i> L01 - Emisores, Custodios y Contrapartes</h2>
    <p>Registro de emisores, custodios de inversiones, depositarios de fondos disponibles y contrapartes en operaciones de reporto</p>
  </div>

  <!-- Loading State -->
  <div *ngIf="isLoading" class="loading-overlay">
    <div class="loading-spinner">
      <i class="pi pi-spinner pi-spin"></i>
      <p>Cargando catálogos...</p>
    </div>
  </div>

  <form [formGroup]="l01Form" (ngSubmit)="onSubmit()" class="l01-form">
    <!-- Sección: Información de Identificación -->
    <div class="form-section">
      <div class="section-header">
        <h3><i class="pi pi-id-card"></i> Información de Identificación</h3>
      </div>
      
      <div class="form-grid">
        <div class="form-group">
          <label for="tipoIdentificacion">Tipo de Identificación *</label>
          <select 
            id="tipoIdentificacion"
            formControlName="tipoIdentificacion"
            class="form-control"
            [class.is-invalid]="isFieldInvalid('tipoIdentificacion')"
            (change)="validateIdentificacion()"
          >
            <option value="">Seleccione el tipo</option>
            <option *ngFor="let catalog of tabla4Catalogs" [value]="catalog.codigo">
              {{ catalog.codigo }} - {{ catalog.descripcion }}
            </option>
          </select>
          <div class="error-message" *ngIf="isFieldInvalid('tipoIdentificacion')">
            El tipo de identificación es requerido
          </div>
          <div class="help-text">
            <i class="pi pi-info-circle"></i>
            {{ getHelpMessage(l01Form.get('tipoIdentificacion')?.value) }}
          </div>
        </div>

        <div class="form-group">
          <label for="identificacion">Identificación *</label>
          <input 
            type="text" 
            id="identificacion"
            formControlName="identificacion"
            class="form-control"
            [class]="getTipoIdentificacionClass(l01Form.get('tipoIdentificacion')?.value)"
            [placeholder]="getHelpMessage(l01Form.get('tipoIdentificacion')?.value)"
            [class.is-invalid]="isFieldInvalid('identificacion')"
            (blur)="validateIdentificacion()"
            [maxlength]="l01Form.get('tipoIdentificacion')?.value === 'R' ? 13 : 7"
          >
          <div class="error-message" *ngIf="isFieldInvalid('identificacion')">
            <span *ngIf="l01Form.get('tipoIdentificacion')?.value === 'R'">
              El RUC es requerido y debe tener exactamente 13 dígitos
            </span>
            <span *ngIf="l01Form.get('tipoIdentificacion')?.value === 'X'">
              El código extranjero es requerido y debe tener exactamente 7 dígitos
            </span>
            <span *ngIf="!l01Form.get('tipoIdentificacion')?.value">
              La identificación es requerida
            </span>
          </div>
          <div class="formatted-value" *ngIf="l01Form.get('identificacion')?.value && l01Form.get('tipoIdentificacion')?.value === 'R'">
            Formateado: {{ formatIdentificacion(l01Form.get('identificacion')?.value) }}
          </div>
        </div>
      </div>
    </div>

    <!-- Sección: Clasificación y Tipo -->
    <div class="form-section">
      <div class="section-header">
        <h3><i class="pi pi-tag"></i> Clasificación y Tipo</h3>
      </div>
      
      <div class="form-grid">
        <div class="form-group">
          <label for="clasificacion">Clasificación *</label>
          <select 
            id="clasificacion"
            formControlName="clasificacion"
            class="form-control"
            [class.is-invalid]="isFieldInvalid('clasificacion')"
          >
            <option value="">Seleccione la clasificación</option>
            <option *ngFor="let catalog of tabla173Catalogs" [value]="catalog.codigo">
              {{ catalog.codigo }} - {{ catalog.descripcion }}
            </option>
          </select>
          <div class="error-message" *ngIf="isFieldInvalid('clasificacion')">
            La clasificación es requerida
          </div>
          <div class="help-text">
            <i class="pi pi-info-circle"></i>
            Clasificación del emisor/custodio/depositario/contraparte
          </div>
        </div>

        <div class="form-group">
          <label for="tipo">Tipo de Emisor *</label>
          <select 
            id="tipo"
            formControlName="tipo"
            class="form-control"
            [class.is-invalid]="isFieldInvalid('tipo')"
          >
            <option value="">Seleccione el tipo</option>
            <option *ngFor="let catalog of tabla73Catalogs" [value]="catalog.codigo">
              {{ catalog.codigo }} - {{ catalog.descripcion }}
            </option>
          </select>
          <div class="error-message" *ngIf="isFieldInvalid('tipo')">
            El tipo de emisor es requerido
          </div>
          <div class="help-text">
            <i class="pi pi-info-circle"></i>
            Sector económico del emisor/custodio/depositario/contraparte
          </div>
        </div>
      </div>
    </div>

    <!-- Sección: Códigos Extranjeros (solo si tipo = X) -->
    <div class="form-section" *ngIf="l01Form.get('tipoIdentificacion')?.value === 'X'">
      <div class="section-header">
        <h3><i class="pi pi-globe"></i> Códigos Extranjeros Disponibles</h3>
      </div>
      
      <div class="foreign-codes-grid">
        <div class="foreign-code-item" *ngFor="let catalog of tabla164Catalogs.slice(0, 10)">
          <div class="code">{{ catalog.codigo }}</div>
          <div class="description">{{ catalog.descripcion }}</div>
          <button 
            type="button" 
            class="btn btn-sm btn-outline"
            (click)="l01Form.get('identificacion')?.setValue(catalog.codigo)"
          >
            Usar
          </button>
        </div>
      </div>
      
      <div class="help-text">
        <i class="pi pi-info-circle"></i>
        Seleccione un código de la lista o ingrese uno manualmente
      </div>
    </div>

    <!-- Resumen de Validación -->
    <div class="form-section validation-section" *ngIf="showValidationResult && validationResult">
      <div class="section-header">
        <h3><i class="pi pi-check-circle"></i> Resultado de Validación</h3>
      </div>
      
      <div class="validation-result" [class]="validationResult.isValid ? 'valid' : 'invalid'">
        <div class="validation-icon">
          <i class="pi" [class]="validationResult.isValid ? 'pi-check-circle' : 'pi-times-circle'"></i>
        </div>
        <div class="validation-content">
          <div class="validation-message">{{ validationResult.message }}</div>
          <div class="validation-errors" *ngIf="!validationResult.isValid && validationResult.errors && validationResult.errors.length > 0">
            <div class="error-item" *ngFor="let error of validationResult.errors">
              <i class="pi pi-exclamation-triangle"></i>
              {{ error.message }}
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Información del Registro -->
    <div class="form-section info-section">
      <div class="section-header">
        <h3><i class="pi pi-info-circle"></i> Información del Registro</h3>
      </div>
      
      <div class="info-grid">
        <div class="info-item">
          <div class="info-label">Código de Entidad</div>
          <div class="info-value">1038 - Banco SudBank</div>
        </div>
        
        <div class="info-item">
          <div class="info-label">Estructura</div>
          <div class="info-value">L01 - Emisores, Custodios y Contrapartes</div>
        </div>
        
        <div class="info-item">
          <div class="info-label">Periodicidad</div>
          <div class="info-value">Eventual (solo nuevos registros)</div>
        </div>
        
        <div class="info-item">
          <div class="info-label">Fecha Límite</div>
          <div class="info-value">Cuando hay nuevos registros</div>
        </div>
      </div>
    </div>

    <!-- Botones de Acción -->
    <div class="form-actions">
      <button type="button" class="btn btn-secondary" (click)="onReset()">
        <i class="pi pi-refresh"></i>
        Limpiar Formulario
      </button>
      
      <button type="button" class="btn btn-info" (click)="onValidate()">
        <i class="pi pi-check-circle"></i>
        Validar Datos
      </button>
      
      <button type="submit" class="btn btn-primary" [disabled]="l01Form.invalid || isSubmitting">
        <i class="pi pi-send" *ngIf="!isSubmitting"></i>
        <i class="pi pi-spinner pi-spin" *ngIf="isSubmitting"></i>
        {{ isSubmitting ? 'Enviando...' : 'Registrar Emisor/Custodio' }}
      </button>
    </div>
  </form>
</div>
