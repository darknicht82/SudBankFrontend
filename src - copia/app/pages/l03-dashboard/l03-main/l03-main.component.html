<!-- ========================================
   COMPONENTE L03 MAIN - TEMPLATE CORREGIDO
   ======================================== -->

<div class="l03-main-container">
  <!-- CABECERA -->
  <div class="header">
    <h1>L03 - Saldo y Liquidaciones de Inversiones</h1>
    <p class="subtitle">Contiene los saldos de todos los t칤tulos que se encuentren registrados en el balance de la entidad, incluso de aquellos que se encuentren vencidos y por lo tanto registrados en la cuenta 1612. Incluye el detalle de los t칤tulos que, habiendo sido reportado su saldo en el mes inmediato anterior, han sido liquidados o vendidos en el mes de reporte.</p>
  </div>

  <!-- INFORMACI칍N DE ESTRUCTURA -->
  <div class="structure-info">
    <div class="card">
      <div class="card-header">
        <h3>游늶 Informaci칩n de la Estructura L03</h3>
      </div>
      <div class="card-content">
        <p><strong>Descripci칩n:</strong> Para poder reportar el saldo o la liquidaci칩n de un t칤tulo en esta estructura, es necesario que dicho t칤tulo se haya reportado previamente en la estructura L02, ya sea en el mismo mes o en cualquiera de los anteriores. Esta estructura deber치 cuadrar con las subcuentas del balance a la misma fecha de corte, seg칰n se haya especificado cada t칤tulo en los campos categor칤a de la inversi칩n (tabla 67) y rango de vencimiento (tabla 68) seg칰n la apertura del Cat치logo 칔nico de Cuentas.</p>
        <p><strong>Periodicidad:</strong> Mensual</p>
        <p><strong>Plazo entrega:</strong> D칤a 15 del mes siguiente</p>
        <p><strong>C칩digo Banco:</strong> 1038</p>
        <p><strong>Formato archivo:</strong> l03Exxxxddmmaaaa.txt</p>
        <p><strong>Fuente:</strong> Manual de Control de Inversiones - SB Marzo 2017</p>
        
        <div class="requirements">
          <strong>Requisitos:</strong>
          <ul>
            <li>Estructura mensual obligatoria</li>
            <li>33 campos de detalle obligatorios</li>
            <li>Formato TXT con separador tabulador</li>
            <li>Validaciones seg칰n manual SB</li>
            <li>Reporte t칤tulo por t칤tulo</li>
          </ul>
        </div>

        <strong>Campos Oficiales:</strong>
        <div style="height: 400px;width: 100%;overflow: auto;border: 1px solid #ccc;background: #fff;">
          <app-l03-fields-table></app-l03-fields-table>
        </div> 
      </div>
    </div>
  </div>

  <!-- RESUMEN -->
  <div class="summary-section">
    <div class="card">
      <div class="card-header">
        <h3>游늵 Resumen del Reporte</h3>
      </div>
      <div class="card-content">
        <div class="summary-grid">
          <div class="summary-item">
            <label>Total Registros:</label>
            <span>{{ getTotalRegistros() }}</span>
          </div>
          <div class="summary-item">
            <label>Fecha Generaci칩n:</label>
            <span>{{ getFechaGeneracion() }}</span>
          </div>
          <div class="summary-item">
            <label>Emisores:</label>
            <span>{{ getTotalEmisores() }}</span>
          </div>
          <div class="summary-item">
            <label>Custodios:</label>
            <span>{{ getTotalCustodios() }}</span>
          </div>
          <div class="summary-item">
            <label>Depositarios:</label>
            <span>{{ getTotalDepositarios() }}</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- TABLA DE DATOS L03 -->
  <div class="data-section">
    <div class="table-container">
      <table class="data-table">
        <thead>
          <tr>
            <th>Tipo de Identificaci칩n</th>
            <th>Emisor</th>
            <th>N칰mero de T칤tulo</th>
            <th>Fecha de Emisi칩n</th>
            <th>Fecha de Compra</th>
            <th>Estado del T칤tulo</th>
            <th>Categor칤a de Inversi칩n</th>
            <th>Rango de Vencimiento</th>
            <th>Tasa de Inter칠s</th>
            <th>Valor en Libros USD</th>
            <th>Valor de Mercado USD</th>
            <th>Calificaci칩n de Riesgo</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let item of datosL03">
            <td class="data-cell">
              <span class="cell-value">{{ item.descripcionTipoIdentificacionEmisor }}</span>
            </td>
            <td class="data-cell">
              <span class="cell-value">{{ item.descripcionIdentificacionEmisor }}</span>
            </td>
            <td class="data-cell">
              <span class="cell-value">{{ item.numeroTitulo }}</span>
            </td>
            <td class="data-cell">
              <span class="cell-value">{{ item.fechaEmision | date:'dd/MM/yyyy' }}</span>
            </td>
            <td class="data-cell">
              <span class="cell-value">{{ item.fechaCompra | date:'dd/MM/yyyy' }}</span>
            </td>
            <td class="data-cell">
              <span class="cell-value">{{ item.descripcionEstadoTitulo }}</span>
            </td>
            <td class="data-cell">
              <span class="cell-value">{{ item.descripcionCategoriaInversion }}</span>
            </td>
            <td class="data-cell">
              <span class="cell-value">{{ item.descripcionRangoVencimiento }}</span>
            </td>
            <td class="data-cell">
              <span class="cell-value">{{ item.tasaInteresNominal | percent:'1.2-4' || '-' }}</span>
            </td>
            <td class="data-cell">
              <span class="cell-value">{{ item.valorLibrosUsd | currency:'USD':'symbol':'1.2-2' || '-' }}</span>
            </td>
            <td class="data-cell">
              <span class="cell-value">{{ item.valorMercadoUsd | currency:'USD':'symbol':'1.2-2' || '-' }}</span>
            </td>
            <td class="data-cell">
              <span class="cell-value">{{ item.descripcionCalificacionRiesgo || '-' }}</span>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <div class="d-flex gap-2">
    <button (click)="validateAndGenerateReport()" [disabled]="loading" class="btn btn-primary">
      <i class="pi pi-check-circle"></i>
      {{ loading ? 'Validando...' : 'Validar y Generar Reporte L03' }}
    </button>

    <button (click)="exportToTxt()" class="btn btn-success">
      <i class="pi pi-download"></i>
      Exportar TXT
    </button>

    <button (click)="openNewRecordModal()" class="btn btn-info">
      <i class="pi pi-plus"></i>
      Crear Nuevo Registro
    </button>
  </div>



  <!-- LOADING -->
  <div *ngIf="loading" class="loading-overlay">
    <div class="loading-spinner">
      <div class="spinner"></div>
      <p>Generando reporte L03...</p>
    </div>
  </div>

  <app-l03-new-record
    [isVisible]="showModalForm"
    (modalClosed)="onModalClosed()"
    (dataSaved)="onModalDataSaved($event)"></app-l03-new-record>

</div>